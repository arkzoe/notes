性能瓶颈:
1. IO瓶颈:热点数据太多,数据库缓存不足,产生大量磁盘I0,效率较低。请求数据太多,带宽不够,网络IO瓶颈。
2. CPU瓶颈:排序、分组、连接查询、聚合统计等SQL会耗费大量的CPU资源,请求数太多,CPU出现瓶颈。
- 拆分策略
	- 垂直拆分
	- 垂直分库：以表为依据，根据业务将不同表拆分到不同库中
		- 每个库表结构不同
		- 数据不同
		- 库并集是全数据
	- 垂直分表：以字段为依据，根据字段属性将不同字段拆分到不同表中
		- 表的结构不同
		- 数据不同，通过一列(主键/外键)关联
		- 表的并集是全数据
	- 水平拆分：拆分数据
	- 水平分库：以字段为依据，按一定策略，将一个库的数据拆分到多个库中
		- 库的表结构一样
		- 库的数据不一样
		- 库并集是全数据
	- 水平分表：字段为依据，按一定策略，将一个表的数据拆分到多个表中
		- 每个表结构一样
		- 每个表数据不一样
		- 表的并集是全数据
- 实现技术
	- shardingJDBC：基于AOP，在应用程序中对本地执行的SQL进行拦截，解析、改写、路由处理。需要自行编码配置实现，只支持java，性能高
	- MyCat：分库分表中间件，不用调整代码，支持多种语言
# MyCat
- 基于java编写的中间件
## 安装
- 安装JDK
- MyCat
- bin：可执行文件，启动停止mycat
- conf：配置文件
- lib：项目依赖包
- logs：日志文件
## 概念
![[MyCat.png]]
## 入门
- 分片配置（）
- useSSL=false&amp：serverTimezone=Asia/Shanghai&amp:characterEncoding=utf8
- server.xml
- 配置用户及权限信息
- ruler.xml
- 分片规则
## 配置
### schema.xml
- 涵盖逻辑库、逻辑表、分片规则、分片节点及数据源
- 三组标签
1. schema
	- schema 标签用于定义MyCat实例中的逻辑库,一个MyCat实例中,可以有多个逻辑库,可以通过schema标签来划分不同的逻辑库。MyCat中的逻辑库的概念,等同于MySQL中的database概念,需要操作某个逻辑库下的表时,也需要切换逻辑库(use xxx)
```xml
<schema name="DB01" checkSQLschema="true" sqlMaxLimit="100" >
	<table name="TB_ORDER" dataNode="dn1, dn2, dn3" rule="auto-sharding-long" />
</ schema>
# name：定义的数据库名
# checkSQLschema：SQL语句操作时指定数据库名，执行时是否自动去除
# sqlMaxLimit：未指定limit查询，列表查询最多

# table定义逻辑库下的逻辑表，需要拆分的在table中定义
核心属性:
· name:定义逻辑表表名,在该逻辑库下唯一
· dataNode:定义逻辑表所属的dataNode,该属性需要与dataNode标签中name对应：多个dataNode逗号分隔
· rule:分片规则的名字,分片规则名字是在rule.xml中定义的
· primaryKey:逻辑表对应真实表的主键
· type:逻辑表的类型,目前逻辑表只有全局表和普通表,如果未配置,就是普通表：全局表,配置为global
```
2. datanode
	- 配置数据节点，数据分片
```xml
<dataNode name="dn1" dataHost="dhost1" database="db01" />
<dataNode name="dn2" dataHost="dhost2" database="db01" />
<dataNode name="dn3" dataHost="dhost3" database="db01" />

核心属性:
· name:定义数据节点名称
· dataHost:数据库实例主机名称,引用自dataHost 标签中name属性
· database:定义分片所属数据库
```
3. datahost
	- 最底层标签，定义具体数据库实现、读写分离、心跳语句
```xml
<dataHost name="dhost1" maxCon="1000" minCon="10" balance="0" writeType="0" dbType="mysql" dbDriver="jdbc">
	<heartbeat>selectuser ()</heartbeat>
	<writeHost host="master" url="jdbc:mysql://192.168.200.210: 3306?useSSL=false&amp：serverTimezone=Asia/Shanghai&amp：characterEncoding=utf8"user="root" password="1234">
	</writeHost>
</dataHost>

核心属性:
· name:唯一标识,供上层标签使用
· maxCon/minCon:最大连接数/最小连接数
· balance:负载均衡策略,取值0,1,2,3
· writeType:写操作分发方式(0:写操作转发到第一个writeHost,第一个挂了,切换到第二个：1:写操作随机分发到配置的writeHost)
· dbDriver:数据库驱动,支持native、jdbc
```
### ruler.xml
- 差分表的规则，灵活使用分片算法，或对同一个分片算法使用不同的参数，让分片过程可控制化
- 两类标签：tableRule、Function
### sever.xml
- 系统配置信息
- system参考资料
- user：用户及权限
# 分片
## 范围--auto-sharding-long
- 根据指定字段及其配置的范围与数据节点的对应情况，决定数据属于哪一个分片
- 外部文件配置
## 取模--mode-long
- 根据字段值与节点数进行取模，据结果决定
- 配置节点数
## 一致性hash--shared-by-murmur
- 计算字段hash
- 相同的哈希因子计算值总是被划分到相同的分区表，不会因为分区节点增加改变原来数据的分区位置
- 配置数据库节点
## 枚举--shared-by-intfile-enumstatus
- 配置可能枚举值，指定数据分布到不同数据节点上，适用省份、性别、状态拆分
- 默认节点
- 外部文件
## 应用指定--shared-by-substring
- 应用自主决定，根据字符子串（数字）计算分片号
- 开始索引
- 截取长度
- 分片数量
- 默认分片
## 固定分片hash算法--shared-by-long-hash
- 类似十进制取模，但是二进制，与11111111进行位&运算
- 特点:
	- 如果是求模,连续的值,分别分配到各个不同的分片：但是此算法会将连续的值可能分配到相同的分片,降低事务处理的难度
	- 可以均匀分配,也可以非均匀分配
	- 分片字段必须为数字类型
- 分片长度最大1024
- count、length长度必须一致
## 字符串hash解析--shared-by-stringhash
- 截取字符串中的指定位置的子字符串，进行hash，算出分片
- hashSlice
	- hash运算位，start:end
	- 0在end中出现代表str.length()
	- -1代表str.length()-1
	- 大于0代表数字本身
## 按天分片--shared-by-date
- begin-end--partionday周期
- 配置表dataNode分片需和分片规则一致
## 按自然月--shared-by-month
- 每个月一个分片
- begin-end
- 配置表dataNode分片需和分片规则一致
# 管理及监控
## 原理
- 解析SQL->分片分析->路由分析->读写分离分析->
- 拿到节点返回数据
- 结果合并->聚合处理->排序处理->分页处理->
## 管理
- 8066：数据访问端口，进行DML和DDL
- 9066：数据库关理端口，mycat服务管理控制功能，用于管理mycat的整个集群状态

| 命令                | 含义               |
| ----------------- | ---------------- |
| show @@help       | 查看Mycat管理工具帮助文档  |
| show @@version    | 查看Mycat的版本       |
| reload @@config   | 重新加载Mycat的配置文件   |
| show @@datasource | 查看Mycat的数据源信息    |
| show @@datanode   | 查看MyCat现有的分片节点信息 |
| show @@threadpool | 查看Mycat的线程池信息    |
| show @@sql        | 查看执行的SQL         |
| show @@sql.sum    | 查看执行的SQL统计       |
### MyCat-eye
- Mycat-web(Mycat-eye)是对mycat-server提供监控服务,功能不局限于对mycat-server使用。他通过JDBC连接对Mycat、Mysql监控,监控远程服务器(目前仅限于linux系统)的cpu、内存、网络、磁盘
- Mycat-eye运行过程中需要依赖zookeeper,因此需要先安装zookeeper
	- 安装zookeeper
	- Mycat-web