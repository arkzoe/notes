- 存储过程是事先经过编译并存储在数据库中的一段SQL语句的集合，调用存储过程可以简化应用开发人员的很多工作，减少数据在数据库和应用服务器之间的传输，对于提高数据处理的效率是有好处的
- 就是数据库SQL语言层面的代码封装与重用
- 特点
	- 封装、复用
	- 可接受参数，返回数据
	- 减少网络交互，提升效率
# 语法
- 创建
```mysql
CREATE PROCEDURE 存储过程名称([参数列表])
BEGIN
	--SQL语句
END;
--命令行中，执行创建存储过程的SQL时，需要通过关键字delimiter指定SQL语句的结束符
```
- 调用
```MYSQL
CALL 名称([参数]);
```
- 查看
```MYSQL
--查询指定数据库的存储过程及状态信息
SELECT*FROM INFORMATION_SCHEMA.ROUTINES WHERE ROUTINE_SCHEMA='xx';
--查询某个存储过程的定义
SHOW CREATE PROCEDURE存储过程名称;
```
- 删除
```MYSQL
DROP PROCEDURE [IF EXISTS] 存储过程名称;
```
## 变量
### 系统变量
- 是MySQL服务器提供，不是用户定义的，属于服务器层面。分为全局变量（GLOBAL）、会话变量（SESSION）默认
- **查看**
```MYSQL
SHOW [SESSION|GLOBAL] VARIABLES;               --查看所有系统变量
SHOW [SESSION|GLOBAL] VARIABLES LIKE '...';    --通过模糊匹配查找变量
SELECT @@[SESSION|GLOBAL] 系统变量名;           --查看指定变量的值
```
- **设置系统变量**
```MYSQL
SET [SESSION|GLOBAL] 系统变量名 = 值;
SET @@[SESSION|GLOBAL] 系统变量名 = 值;
```
- 注：mysql服务重新启动之后,所设置的全局参数会失效,要想不失效,可以在/etc/my.cnf中配置
### 用户定义变量
- 是用户根据需要自己定义的变量,用户变量不用提前声明,在用的时候直接用“@变量名”使用就可以。其作用域为当前连接
- **赋值**
```mysql
SET @var_name = expr[,var_name = expr]...;
SET @var_name := expr[,var_name := expr]...;
SELECT @var_name := expr[,var_name := expr]...;
SELECT 字段名 INTO @var_name FROM 表名;
```
- **使用**
```MYSQL
SELECT @var_name;
```
- 注：不初始化NULL
### 局部变量
- 是根据需要定义的在局部生效的变量,访问之前,需要DECLARE声明。可用作存储过程内的局部变量和输入参数,局部变量的范围是在其内声明的BEGIN ... END块
- **声明**
```MYSQL
DECLARE 变量名 变量类型[DEFAULT...];
```
- 类型：INT、BIGINT、CHAR、VARCHAR、DATE、TIME等
- **赋值**
```MYSQL
SET 变量名 = 值;
SET 变量名 := 值;
SELECT 字段名 INTO 变量名 FROM 表名...;
```
## if
```MYSQL
IF 条件1 THEN
...
ELSE 条件2 THEN
...
ELSE
...
END IF;
```
## 参数

| 类型    | 含义    |     |
| ----- | ----- | --- |
| IN    | 作为输入  | 默认  |
| OUT   | 输出    |     |
| INOUT | 输入，输出 |     |
```mysql
CREATE PROCEDURE 存储过程名称([IN OUT INOUT 参数名 参数类型])
BEGIN
	--SQL语句
END;
```
## CASE
```MYSQL
CASE case_value
	WHEN when_value1 THEN statement_list1
	[WHEN when_value2 THEN statement_list2]...
	[ELSE statement_list]
END CASE;

CASE
	WHEN search_condition1 THEN statement_list1
	[WHEN search_condition2 THEN statement_list2]...
	[ELSE statement_list]
END CASE;
```
## 循环
- **while**
	- 满足条件执行
```MYSQL
WHILE 条件 DO
	SQL逻辑
END WHILE;
```
- **repeat**
	- do...while满足条件退出循环
```MYSQL
REPEAT
	SQL逻辑...
	UNTIL 条件
END REPEAT;
```
- **loop**
	- 不增加退出条件，死循环
	- leave：break，配合循环使用，退出循环
	- iterate：continue，必须在循环中，跳过当前循环，进入下一次循环
```MYSQL
[begin_label:] LOOP
	SQL逻辑
END LOOP [end_label];

LEAVE label;   --退出指定标记的循环体
ITERATE label; --直接进入下一次循环
```
## 游标
- 是用来存储查询结果集的数据类型,在存储过程和函数中可以使用游标对结果集进行循环的处理。游标的使用包括游标的声明、OPEN、FETCH和CLOSE
- **声明**
```mysql
DECLARE 游标名称 CURSOR FOR 查询语句;
```
- **打开**
```mysql
OPEN 游标名称
```
- **获取游标记录**
```mysql
FETCH 游标名称 INTO 变量[,变量];
``` 
- **关闭游标**
```mysql
CLOSE 游标名称;
```
## 条件出理程序
- 可以用来定义在流程控制结构执行过程中遇到问题时相应的处理步骤
```mysql
DECLARE handler_action HANDLER FOR condition_value [, condition_value] ... statement ;

handler_action
	CONTINUE: 继续执行当前程序
	EXIT:     终止执行当前程序
condition_value
	SQLSTATE sqlstate_value:状态码,如02000
	SQLWARNING:             所有以01开头的SQLSTATE代码的简写
	NOT FOUND:              所有以02开头的SQLSTATE代码的简写
	SQLEXCEPTION:           所有没有被SQLWARNING或NOT FOUND捕获的SQLSTATE代码的简写
```
# 存储函数
- 有返回值的存储过程，函数传参只能是IN
```mysql
CREATE FUNCTION 存储函数名称([参数列表])
RETURNS type [characteristic ... ]
BEGIN
	-- SQL语句
	RETURN ...;
END ;

characteristic说明:
· DETERMINISTIC:相同的输入参数总是产生相同的结果
· NO SQL:不包含SQL语句。
· READS SQL DATA:包含读取数据的语句,但不包含写入数据的语句。
```