# Session实现登录
![[Pasted image 20260118172735.png]]
1. 发送验证码
	- 请求方式POST
	- 路径/user/code
	- 参数phone
	- 返回值无
```java
@Override  
public Result sedCode(String phone, HttpSession session) {  
    //1. 校验手机号  
    if (RegexUtils.isPhoneInvalid(phone)) {  
        //2.如果不符合，返回错误信息  
        return Result.fail("手机号格式错误");  
    }  
  
    //3. 符合，生成验证码  
    String code = RandomUtil.randomNumbers(6);  
    //4. 保存验证码到session  
    session.setAttribute("code",code);  
    //5. 发送验证码  
    log.debug("发送短信验证码成功，验证码:{}",code);  
    //返回ok  
    return Result.ok();  
}
```
2. 登录
	- 请求方式POST
	- 路径/user/login
	- 参数phone，code
	- 返回值无
```java
@Override  
public Result login(LoginFormDTO loginForm, HttpSession session) {  
    //1. 校验手机号  
    String phone = loginForm.getPhone();  
    if (RegexUtils.isPhoneInvalid(phone)) {  
        return Result.fail("手机号格式错误");  
    }  
    //2. 校验验证码  
    Object cacheCode = session.getAttribute("code");  
    String code = loginForm.getCode();  
    if (cacheCode == null || !cacheCode.toString().equals(code)){  
        //3. 不一致，报错  
        return Result.fail("验证码错误");  
    }  
  
    //4.一致，根据手机号查询用户  
    User user = query().eq("phone", phone).one();  
  
    //5. 判断用户是否存在  
    if (user == null){  
        //6. 不存在，创建新用户  
        user = createUserWithPhone(phone);  
    }  
  
    //7.保存用户信息到session  
    session.setAttribute("user",BeanUtil.copyProperties(user,UserDTO.class));  
    return Result.ok();  
}
private User createUserWithPhone(String phone) {  
    // 1.创建用户  
    User user = new User();  
    user.setPhone(phone);  
    user.setNickName(USER_NICK_NAME_PREFIX + RandomUtil.randomString(10));  
    // 2.保存用户  
    save(user);  
    return user;  
}
```
3. 登录校验
- 使用拦截器过滤请求，用户数据保存到ThreadLocal
![[Pasted image 20260118181655.png]]
```java
public class LoginInterceptor implements HandlerInterceptor {  
    @Override  
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {  
        //1. 获取session  
        HttpSession session = request.getSession();  
        //2.获取session中的用户  
        Object user = session.getAttribute("user");  
        //3. 判断用户是否存在  
        if (user == null){  
            //4. 不存在，拦截，返回401  
            response.setStatus(401);  
            return false;  
        }  
  
        //5. 存在 保存用户信息到ThreadLocal  
        UserHolder.saveUser((UserDTO) user); 
        //隐藏用户信息，直接返回user对象能直接看到
        //6. 放行  
        return true;  
    }  
  
    @Override  
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {  
        //移除用户  
        UserHolder.removeUser();  
    }  
}

//配置拦截器
@Configuration  
public class MvcConfig implements WebMvcConfigurer {  
  
    @Resource  
    private StringRedisTemplate stringRedisTemplate;  
  
    @Override  
    public void addInterceptors(InterceptorRegistry registry) {  
        // 登录拦截器  
        registry.addInterceptor(new LoginInterceptor())  
                .excludePathPatterns(  
                        "/shop/**",  
                        "/voucher/**",  
                        "/shop-type/**",  
                        "/upload/**",  
                        "/blog/hot",  
                        "/user/code",  
                        "/user/login"  
                );  
    }  
}
```
## session共享问题
- 多台tomcat不共享session存储空间，请求切换到不同tomcat服务导致数据丢失
- 替代需满足：数据共享、内存存储、kv结构
## 基于Redis实现session共享登录
- 数据类型选择，key选择
![[Pasted image 20260119164352.png]]
1. 发送验证码
```java
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements IUserService {  
  
    @Resource  
    private StringRedisTemplate stringRedisTemplate;  
    @Override  
    public Result sedCode(String phone, HttpSession session) {  
        //1. 校验手机号  
        if (RegexUtils.isPhoneInvalid(phone)) {  
            //2.如果不符合，返回错误信息  
            return Result.fail("手机号格式错误");  
        }  
  
        //3. 符合，生成验证码  
        String code = RandomUtil.randomNumbers(6);  
        //4. 保存验证码到redis，加前缀区分  
        stringRedisTemplate.opsForValue().set(LOGIN_CODE_KEY+phone,code,LOGIN_CODE_TTL, TimeUnit.MINUTES);  //修改保存逻辑，使用redis模板保存，使用工具定义的常量
        //5. 发送验证码  
        log.debug("发送短信验证码成功，验证码:{}",code);  
        //返回ok  
        return Result.ok();  
    }
```
![[Pasted image 20260119163941.png]]
2. 短信验证登录
```java
@Override  
public Result login(LoginFormDTO loginForm, HttpSession session) {  
    //1. 校验手机号  
    String phone = loginForm.getPhone();  
    if (RegexUtils.isPhoneInvalid(phone)) {  
        return Result.fail("手机号格式错误");  
    }  
    //TODO 2. 从redis获取并校验验证码  
    String cacheCode = stringRedisTemplate.opsForValue().get(LOGIN_CODE_KEY+phone);  
    String code = loginForm.getCode();  
    if (cacheCode == null || !cacheCode.equals(code)){  
        //3. 不一致，报错  
        return Result.fail("验证码错误");  
    }  
  
    //4.一致，根据手机号查询用户  
    User user = query().eq("phone", phone).one();  
  
    //5. 判断用户是否存在  
    if (user == null){  
        //6. 不存在，创建新用户  
        user = createUserWithPhone(phone);  
    }  
  
    //TODO 7.保存用户信息到redis  
    //7.1 随机生成token作为登录令牌  
    String token = UUID.randomUUID().toString(true);  
    // 7.2 将user对象转为hash存储  
    UserDTO userDTO = BeanUtil.copyProperties(user, UserDTO.class);  
    Map<String, Object> userMap = BeanUtil.beanToMap(userDTO);  
    // 7.3 存储  
    stringRedisTemplate.opsForHash().putAll(LOGIN_USER_KEY+token,userMap);  
    //7.4 设置有效期  
    stringRedisTemplate.expire(LOGIN_USER_KEY+token,LOGIN_USER_TTL, TimeUnit.MINUTES);  
    //8 返回token  
    return Result.ok(token);  
}
```